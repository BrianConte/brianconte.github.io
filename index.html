<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css?family=Anton" rel="stylesheet" type="text/css"></link>
  <link type="text/css" href="examplegantt.css" rel="stylesheet" />
  <style>
    .nodesToolTip {
      max-width: 250px;
      background-color: rgba(31, 119, 180, 1.0);
      border-radius: 10px;
      padding: 5px;
      font-family: Arial;
      font-size: 12px;
      color: white;
      position: absolute;
      display: none;
    }

    .barText {
      font-family: Anton;
      font-size: 12px;
    }

    .tooltip {
      display: inline;
      position: relative;
    }

    .tooltip:hover:after {
      background: #333;
      background: rgba(0, 0, 0, .8);
      border-radius: 5px;
      bottom: 26px;
      color: #fff;
      content: attr(title);
      left: 20%;
      padding: 5px 15px;
      position: absolute;
      z-index: 98;
      width: 220px;
      max-width: 220px;
    }

    .links line {
      stroke: #999;
      stroke-opacity: 0.6;
    }

    .nodes circle {
      stroke: #fff;
      stroke-width: 1.5px;
    }
  </style>
</head>

<body>
  <!--<object id="skillsObject" data="skills.svg" type="image/svg+xml" width="400" height="400" style="border:1px solid black">SVG not supported</object>-->
  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="600" height="400"
    viewBox="0 0 600 400" id="skills"></svg>
  <div id="experience"></div>

  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="d3-tip.js"></script>
  <!--  <script type="text/javascript" src="../lib/d3/d3.v3.js"></script>
	<script type="text/javascript" src="../lib/d3/moment.min.js"></script>
  <script type="text/javascript" src="example3.js"></script>
-->
  <script type="text/javascript" src="gantt.js"></script>
  <script type="text/javascript" src="examplegantt.js"></script>
</body>
<script>
  var svgSkills = d3.select("#skills"),
    width = +svgSkills.attr("width"),
    height = +svgSkills.attr("height");

  var color = d3.scaleOrdinal(d3.schemeCategory20);

  var simulation = d3.forceSimulation()
    .force("link", d3.forceLink().distance(100).strength(1).id(function (d) {
      return d.id;
    }))
    .force("charge", d3.forceManyBody())
    .force("collide", d3.forceCollide(function (d) {
      return d.r + 8
    }).iterations(32))
    .force("center", d3.forceCenter(width / 2, height / 2));

  d3.json("skills.json", function (error, graph) {
    if (error) throw error;

    var link = svgSkills.append("g")
      .attr("class", "links")
      .selectAll("line")
      .data(graph.links)
      .enter().append("line")
      .attr("stroke-width", function (d) {
        return Math.sqrt(d.value);
      });

    /* Initialize tooltip */
    var div = d3.select("body").append("div").attr("class", "nodesToolTip");
    var tip = d3
      .tip()
      .html(function (d) {
        if (d.fullText)
          return "<div class='nodesToolTip'>" + d.fullText + "</div>";
      });

    /* Invoke the tip in the context of your visualization */
    svgSkills.call(tip)

    function getNodePos(el)
      {
          var body = d3.select('body').node();
      
          for (var lx = 0, ly = 0;
               el != null && el != body;
               lx += (el.offsetLeft || el.clientLeft), ly += (el.offsetTop || el.clientTop), el = (el.offsetParent || el.parentNode))
              ;
          return {x: lx, y: ly};
      }
      var root = d3.select("svg");
      var scr = { x: window.scrollX, y: window.scrollY, w: window.innerWidth, h: window.innerHeight };
      var body_sel = d3.select('body');
      var body = { w: body_sel.node().offsetWidth, h: body_sel.node().offsetHeight };
      var doc = { w: document.width, h: document.height };
      var svgpos = getNodePos(root.node());
      var dist = { x: 10, y: 10 };

    var node_g = svgSkills.append("g")
      .attr("class", "nodes")
      .selectAll("circle")
      .data(graph.nodes)
      .enter().append("g")
      .attr("class", "cls_node_g")
      .on("mouseout", function(d){
        div.style("display", "none");
      })
      .on("mousemove", function(d){
        if (d.fullText){
          div.style("right", "");
          div.style("left", "");
          div.style("bottom", "");
          div.style("top", "");
          var m = d3.mouse(root.node());
          scr.x = window.scrollX;
          scr.y = window.scrollY;
          m[0] += svgpos.x;
          m[1] += svgpos.y;
          if (m[0] > scr.x + scr.w / 2) {
              div.style("right", (body.w - m[0] + dist.x) + "px");
          }
          else {
              div.style("left", (m[0] + dist.x) + "px");
          }

          if (m[1] > scr.y + scr.h / 2) {
              div.style("bottom", (body.h - m[1] + dist.y) + "px");
          }
          else {
              div.style("top", (m[1] + dist.y) + "px");
          }
          div.style("display", "inline-block");
          div.html(d.fullText);
        }
    });
      
    var node = node_g.append("circle")
      /*.on('mouseover', tip.show)
      .on('mouseout', tip.hide)*/
      .attr("r", function (d) {
        return d.r;
      })
      .attr("fill", function (d) {
        return color(d.group);
      })
      .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended));

    /*var text = svgSkills.selectAll("text")
      .data(graph.nodes)
      .enter()
      .append("g");*/

    var text = node_g
      .append("g");

    text
      .append("text")
      .text(function (d) {
        return d.id;
      })
      .attr("dy", 0)
      .attr("dx", 0)
      .attr("text-anchor", "middle")
      .style("font-family", "Anton")
      .style("font-size", function (d) {
        return d.r / 3 + "px"
      })
      .style("fill", "white")
      .style("text-transform", "uppercase");

    svgSkills.selectAll("text")
      .data(graph.nodes)
      .call(wrap, function (d) {
        return d.r * 2
      });


    /*node.append("title")
      .text(function (d) {
        return d.fullText;
      });*/

    simulation
      .nodes(graph.nodes)
      .on("tick", ticked);

    simulation.force("link")
      .links(graph.links);

    function ticked() {
      link
        .attr("x1", function (d) {
          return d.source.x;
        })
        .attr("y1", function (d) {
          return d.source.y;
        })
        .attr("x2", function (d) {
          return d.target.x;
        })
        .attr("y2", function (d) {
          return d.target.y;
        });

      node
        .attr("cx", function (d) {
          return d.x;
        })
        .attr("cy", function (d) {
          return d.y;
        });

      text
        .attr("transform", function (d) {
          return "translate(" + d.x + "," + d.y + ")";
        })
    }
  });

  function dragstarted(d) {
    if (!d3.event.active) simulation.alphaTarget(0.3).restart();
    d.fx = d.x;
    d.fy = d.y;
  }

  function dragged(d) {
    d.fx = d3.event.x;
    d.fy = d3.event.y;
  }

  function dragended(d) {
    if (!d3.event.active) simulation.alphaTarget(0);
    d.fx = null;
    d.fy = null;
  }

  function wrap(text, width) {
    text.each(function (d) {
      var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        //        dy = parseFloat(text.attr("dy")),
        dy = 0.4
      tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > width(d)) {
          if (line.length > 1) {
            tspan.node().setAttribute("dy", (dy - 0.55) + "em")
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            //        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
            tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", lineHeight + "em").text(word);
          }
        }
      }
    });
  }

</script>

</body>

</html>
